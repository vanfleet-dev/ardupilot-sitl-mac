#!/bin/bash

# ArduPilot SITL CLI Wrapper
# Usage: sitl [plane|quadplane|copter|rover|stop|status|shell|logs]

set -e

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOCKER_COMPOSE_FILE="$SCRIPT_DIR/../sitl/docker-compose.yml"
CONTAINER_NAME="ardupilot-sitl"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper functions
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

show_help() {
    cat << EOF
ArduPilot SITL Launcher - Headless Docker Wrapper

Usage:
  sitl <vehicle-type> [options]   Start SITL for specified vehicle
  sitl stop                       Stop the SITL container
  sitl status                     Check if SITL is running
  sitl shell                      Open bash shell in container
  sitl logs                       View SITL logs
  sitl --help                     Show this help message

Vehicle Types:
  plane           ArduPlane (default frame)
  quadplane       ArduPlane with quadplane frame
  copter          ArduCopter (quad frame)
  copter-hexa     ArduCopter with hexacopter frame
  copter-octa     ArduCopter with octocopter frame
  copter-tri      ArduCopter with tricopter frame
  copter-heli     ArduCopter with helicopter frame
  rover           Rover (default frame)
  rover-skid      Rover with skid steering

Options:
  --frame <name>  Specify custom frame (overrides default)
  --wipe          Wipe eeprom and start fresh
  --location <n>  Start at named location from locations.txt
  --speedup <n>   Set simulation speedup factor (default: 1)

Examples:
  sitl plane                      # Start plane SITL
  sitl quadplane --wipe           # Start quadplane, wipe params
  sitl copter --location CMAC     # Start copter at CMAC location
  sitl copter --frame hexa        # Start hexacopter

After starting SITL, connect with your local MAVProxy:
  mavproxy.py --master=localhost:14550

MAVLink Endpoint: localhost:14550 (UDP)
EOF
}

check_docker() {
    if ! command -v docker &> /dev/null; then
        log_error "Docker not found. Please install Docker Desktop."
        exit 1
    fi
    
    if ! docker info &> /dev/null; then
        log_error "Docker daemon not running. Please start Docker Desktop."
        exit 1
    fi
}

get_container_status() {
    local status=$(docker ps --filter "name=$CONTAINER_NAME" --format "{{.Status}}" 2>/dev/null)
    if [ -z "$status" ]; then
        echo "not running"
    else
        echo "$status"
    fi
}

start_sitl() {
    local vehicle=$1
    local frame=$2
    local extra_args=$3
    
    check_docker
    
    # Check if container is already running
    if [ "$(get_container_status)" != "not running" ]; then
        log_warn "SITL is already running"
        log_info "Stop it first with: sitl stop"
        exit 1
    fi
    
    # Clean up any stopped container with same name
    docker rm -f $CONTAINER_NAME 2>/dev/null || true
    
    log_info "Starting SITL: $vehicle (frame: $frame)"
    
    # Set environment variables for docker-compose
    export SITL_VEHICLE="$vehicle"
    export SITL_FRAME="$frame"
    
    # Start container
    docker-compose -f "$DOCKER_COMPOSE_FILE" up -d
    
    # Wait a moment for SITL to initialize
    sleep 2
    
    # Check if container is running
    if [ "$(get_container_status)" != "not running" ]; then
        log_info "SITL started successfully!"
        log_info "MAVLink endpoint: localhost:14550 (UDP)"
        log_info ""
        log_info "Connect with your local MAVProxy:"
        log_info "  mavproxy.py --master=localhost:14550"
    else
        log_error "Failed to start SITL. Check logs with: sitl logs"
        exit 1
    fi
}

stop_sitl() {
    check_docker
    
    if [ "$(get_container_status)" = "not running" ]; then
        log_warn "SITL is not running"
        return 0
    fi
    
    log_info "Stopping SITL..."
    docker-compose -f "$DOCKER_COMPOSE_FILE" down
    log_info "SITL stopped"
}

show_status() {
    check_docker
    
    local status=$(get_container_status)
    
    if [ "$status" = "not running" ]; then
        echo "SITL Status: Not running"
    else
        echo "SITL Status: Running"
        echo "Container: $CONTAINER_NAME"
        echo "MAVLink: localhost:14550 (UDP)"
        echo ""
        docker ps --filter "name=$CONTAINER_NAME" --format "Uptime: {{.RunningFor}}\nImage: {{.Image}}"
    fi
}

open_shell() {
    check_docker
    
    if [ "$(get_container_status)" = "not running" ]; then
        log_error "SITL is not running. Start it first."
        exit 1
    fi
    
    log_info "Opening shell in SITL container..."
    docker exec -it $CONTAINER_NAME bash
}

show_logs() {
    check_docker
    
    if [ "$(get_container_status)" = "not running" ]; then
        # Show last logs from stopped container if available
        docker logs $CONTAINER_NAME 2>/dev/null || log_warn "No logs available"
    else
        docker logs -f $CONTAINER_NAME
    fi
}

# Parse vehicle types and options
parse_args() {
    local vehicle=""
    local frame=""
    local extra_args=""
    
    case "$1" in
        plane)
            vehicle="ArduPlane"
            frame="plane"
            ;;
        quadplane)
            vehicle="ArduPlane"
            frame="quadplane"
            ;;
        copter|quad)
            vehicle="ArduCopter"
            frame="quad"
            ;;
        copter-hexa|hexa)
            vehicle="ArduCopter"
            frame="hexa"
            ;;
        copter-octa|octa)
            vehicle="ArduCopter"
            frame="octa"
            ;;
        copter-tri|tri)
            vehicle="ArduCopter"
            frame="tri"
            ;;
        copter-heli|heli)
            vehicle="ArduCopter"
            frame="heli"
            ;;
        rover)
            vehicle="Rover"
            frame="rover"
            ;;
        rover-skid)
            vehicle="Rover"
            frame="rover-skid"
            ;;
        stop)
            stop_sitl
            exit 0
            ;;
        status)
            show_status
            exit 0
            ;;
        shell)
            open_shell
            exit 0
            ;;
        logs)
            show_logs
            exit 0
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            log_error "Unknown vehicle type or command: $1"
            echo ""
            show_help
            exit 1
            ;;
    esac
    
    # Process additional arguments
    shift
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --frame)
                frame="$2"
                shift 2
                ;;
            --wipe)
                extra_args="$extra_args -w"
                shift
                ;;
            --location|-L)
                extra_args="$extra_args -L $2"
                shift 2
                ;;
            --speedup)
                extra_args="$extra_args --speedup $2"
                shift 2
                ;;
            *)
                log_warn "Unknown option: $1"
                shift
                ;;
        esac
    done
    
    start_sitl "$vehicle" "$frame" "$extra_args"
}

# Main entry point
main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi
    
    parse_args "$@"
}

main "$@"
