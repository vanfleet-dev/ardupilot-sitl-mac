#!/bin/bash

# ArduPilot SITL CLI Wrapper
# Usage: sitl [plane|quadplane|copter|rover|stop|status|shell|logs]

set -e

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOCKER_COMPOSE_FILE="$SCRIPT_DIR/../sitl/docker-compose.yml"
CONTAINER_NAME="ardupilot-sitl"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

show_help() {
    cat << EOF
ArduPilot SITL Launcher - Headless Docker Wrapper

Usage:
  sitl <vehicle-type> [options]         Start SITL for specified vehicle
  sitl <vehicle-type> --swarm <count>   Start multiple vehicles (swarm)
  sitl stop                             Stop the SITL container
  sitl status                           Check if SITL is running
  sitl shell                            Open bash shell in container
  sitl logs                             View SITL logs
  sitl --help                           Show this help message

Vehicle Types:
  plane           ArduPlane (default frame)
  quadplane       ArduPlane with quadplane frame
  copter          ArduCopter (quad frame)
  copter-hexa     ArduCopter with hexacopter frame
  copter-octa     ArduCopter with octocopter frame
  copter-tri      ArduCopter with tricopter frame
  copter-heli     ArduCopter with helicopter frame
  rover           Rover (default frame)
  rover-skid      Rover with skid steering

Options:
  --swarm <n>     Launch n vehicles as a swarm (same vehicle type)
  --frame <name>  Specify custom frame (overrides default)
  --wipe          Wipe eeprom and start fresh
  --location <n>  Start at named location from locations.txt
  --speedup <n>   Set simulation speedup factor (default: 1)
  --offset-line   Spread swarm in a line (heading,distance). Default: 90,10

Examples:
  sitl plane                              # Start single plane SITL
  sitl copter --swarm 5                   # Start 5 copters in a swarm
  sitl plane --swarm 3 --location CMAC    # Start 3 planes at CMAC
  sitl copter --swarm 5 --offset-line 90,10   # 5 copters in east-west line
  sitl quadplane --wipe                   # Start quadplane, wipe params

After starting SITL, connect with your local MAVProxy:
  Single vehicle:   mavproxy.py --master=localhost:14550
  Swarm:            mavproxy.py --master=localhost:14550 (auto-detects all)

MAVLink Endpoint: localhost:14550 (UDP)

Swarm Mode:
  - All vehicles must be the same type
  - Auto-assigns unique SYS IDs (1, 2, 3, etc.)
  - Vehicles spawn in a line formation
  - MAVProxy can control all vehicles simultaneously
EOF
}

check_docker() {
    if ! command -v docker &> /dev/null; then
        log_error "Docker not found. Please install Docker Desktop."
        exit 1
    fi
    
    if ! docker info &> /dev/null; then
        log_error "Docker daemon not running. Please start Docker Desktop."
        exit 1
    fi
}

get_container_status() {
    local status=$(docker ps --filter "name=$CONTAINER_NAME" --format "{{.Status}}" 2>/dev/null)
    if [ -z "$status" ]; then
        echo "not running"
    else
        echo "$status"
    fi
}

start_sitl() {
    local vehicle=$1
    local frame=$2
    local extra_args=$3
    local swarm_count=$4
    local offset_line=$5
    
    check_docker
    
    # Check if container is already running
    if [ "$(get_container_status)" != "not running" ]; then
        log_warn "SITL is already running"
        log_info "Stop it first with: sitl stop"
        exit 1
    fi
    
    # Clean up any stopped container with same name
    docker rm -f $CONTAINER_NAME 2>/dev/null || true
    
    if [ -n "$swarm_count" ]; then
        log_info "Starting SITL Swarm: $vehicle (frame: $frame, count: $swarm_count)"
        
        # Set environment variables for swarm mode
        export SITL_VEHICLE="$vehicle"
        export SITL_FRAME="$frame"
        export SWARM_COUNT="$swarm_count"
        export OFFSET_LINE="$offset_line"
        export SWARM_MODE="true"
        export SITL_LOCATION="${SITL_LOCATION:-CMAC}"
        
        # Start container with swarm profile
        docker-compose -f "$DOCKER_COMPOSE_FILE" --profile swarm up -d
        
        # Wait for initialization
        sleep 3
        
        if [ "$(get_container_status)" != "not running" ]; then
            log_info "Swarm started successfully!"
            log_info "Vehicles: $swarm_count $vehicle(s) with SYS IDs 1-$swarm_count"
            log_info "MAVLink endpoint: localhost:14550 (UDP)"
            log_info ""
            log_info "Connect with your local MAVProxy:"
            log_info "  mavproxy.py --master=localhost:14550"
            log_info ""
            log_info "MAVProxy multi-vehicle commands:"
            log_info "  vehicle <n>     - Switch to vehicle n"
            log_info "  alllinks <cmd>  - Send command to all vehicles"
        else
            log_error "Failed to start swarm. Check logs with: sitl logs"
            exit 1
        fi
    else
        log_info "Starting SITL: $vehicle (frame: $frame)"
        
        # Set environment variables for single vehicle
        export SITL_VEHICLE="$vehicle"
        export SITL_FRAME="$frame"
        export SWARM_MODE="false"
        unset SWARM_COUNT
        unset OFFSET_LINE
        
        # Start container
        docker-compose -f "$DOCKER_COMPOSE_FILE" up -d
        
        # Wait a moment for SITL to initialize
        sleep 2
        
        if [ "$(get_container_status)" != "not running" ]; then
            log_info "SITL started successfully!"
            log_info "MAVLink endpoint: localhost:14550 (UDP)"
            log_info ""
            log_info "Connect with your local MAVProxy:"
            log_info "  mavproxy.py --master=localhost:14550"
        else
            log_error "Failed to start SITL. Check logs with: sitl logs"
            exit 1
        fi
    fi
}

stop_sitl() {
    check_docker
    
    if [ "$(get_container_status)" = "not running" ]; then
        log_warn "SITL is not running"
        return 0
    fi
    
    log_info "Stopping SITL..."
    docker-compose -f "$DOCKER_COMPOSE_FILE" --profile swarm down 2>/dev/null || docker-compose -f "$DOCKER_COMPOSE_FILE" down
    log_info "SITL stopped"
}

show_status() {
    check_docker
    
    local status=$(get_container_status)
    
    if [ "$status" = "not running" ]; then
        echo "SITL Status: Not running"
    else
        echo "SITL Status: Running"
        echo "Container: $CONTAINER_NAME"
        echo "MAVLink: localhost:14550 (UDP)"
        
        # Check if running in swarm mode
        local swarm_check=$(docker exec $CONTAINER_NAME printenv SWARM_MODE 2>/dev/null || echo "false")
        if [ "$swarm_check" = "true" ]; then
            local count=$(docker exec $CONTAINER_NAME printenv SWARM_COUNT 2>/dev/null || echo "?")
            echo "Mode: Swarm ($count vehicles)"
        else
            echo "Mode: Single Vehicle"
        fi
        
        echo ""
        docker ps --filter "name=$CONTAINER_NAME" --format "Uptime: {{.RunningFor}}\nImage: {{.Image}}"
    fi
}

open_shell() {
    check_docker
    
    if [ "$(get_container_status)" = "not running" ]; then
        log_error "SITL is not running. Start it first."
        exit 1
    fi
    
    log_info "Opening shell in SITL container..."
    docker exec -it $CONTAINER_NAME bash
}

show_logs() {
    check_docker
    
    if [ "$(get_container_status)" = "not running" ]; then
        # Show last logs from stopped container if available
        docker logs $CONTAINER_NAME 2>/dev/null || log_warn "No logs available"
    else
        docker logs -f $CONTAINER_NAME
    fi
}

# Parse vehicle types and options
parse_args() {
    local vehicle=""
    local frame=""
    local extra_args=""
    local swarm_count=""
    local offset_line="90,10"  # Default: 90 degrees, 10 meters
    
    case "$1" in
        plane)
            vehicle="ArduPlane"
            frame="plane"
            ;;
        quadplane)
            vehicle="ArduPlane"
            frame="quadplane"
            ;;
        copter|quad)
            vehicle="ArduCopter"
            frame="quad"
            ;;
        copter-hexa|hexa)
            vehicle="ArduCopter"
            frame="hexa"
            ;;
        copter-octa|octa)
            vehicle="ArduCopter"
            frame="octa"
            ;;
        copter-tri|tri)
            vehicle="ArduCopter"
            frame="tri"
            ;;
        copter-heli|heli)
            vehicle="ArduCopter"
            frame="heli"
            ;;
        rover)
            vehicle="Rover"
            frame="rover"
            ;;
        rover-skid)
            vehicle="Rover"
            frame="rover-skid"
            ;;
        stop)
            stop_sitl
            exit 0
            ;;
        status)
            show_status
            exit 0
            ;;
        shell)
            open_shell
            exit 0
            ;;
        logs)
            show_logs
            exit 0
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            log_error "Unknown vehicle type or command: $1"
            echo ""
            show_help
            exit 1
            ;;
    esac
    
    # Process additional arguments
    shift
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --swarm)
                if [[ -z "$2" || "$2" =~ ^- ]]; then
                    log_error "--swarm requires a count (e.g., --swarm 5)"
                    exit 1
                fi
                swarm_count="$2"
                if ! [[ "$swarm_count" =~ ^[0-9]+$ ]] || [ "$swarm_count" -lt 1 ]; then
                    log_error "Swarm count must be a positive number"
                    exit 1
                fi
                if [ "$swarm_count" -gt 20 ]; then
                    log_warn "Large swarm count ($swarm_count). This may impact performance."
                fi
                shift 2
                ;;
            --offset-line)
                offset_line="$2"
                shift 2
                ;;
            --frame)
                frame="$2"
                shift 2
                ;;
            --wipe)
                extra_args="$extra_args -w"
                shift
                ;;
            --location|-L)
                extra_args="$extra_args -L $2"
                shift 2
                ;;
            --speedup)
                extra_args="$extra_args --speedup $2"
                shift 2
                ;;
            *)
                log_warn "Unknown option: $1"
                shift
                ;;
        esac
    done
    
    start_sitl "$vehicle" "$frame" "$extra_args" "$swarm_count" "$offset_line"
}

# Main entry point
main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi
    
    parse_args "$@"
}

main "$@"
